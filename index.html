<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presente pra ela</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@200;300;400;500&family=Poppins:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --bg-color: #050510;
            --star-white: #e2e8f0;
            --star-discovered: #bae6fd; /* Ciano pálido para descobertas */
            --star-gold: #fbbf24;       /* Dourado para dicas e final */
            --text-main: rgba(255, 255, 255, 0.95);
            --transition-soft: all 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Montserrat', sans-serif;
            touch-action: none; 
        }

        #canvas {
            display: block;
            cursor: grab;
            width: 100%;
            height: 100%;
            transition: opacity 2s ease;
        }
        
        #canvas:active { cursor: grabbing; }

        /* --- HUD DE PROGRESSO (MINIMALISTA) --- */
        .discovery-hud {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.5); 
            padding: 0.5rem 1.2rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none;
        }

        .discovery-hud.visible { opacity: 1; }

        .hud-counter {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            letter-spacing: 0.1em;
        }

        /* --- TELA FINAL --- */
        #finale-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6); /* Levemente mais escuro para leitura */
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 3s ease;
            backdrop-filter: blur(5px);
        }

        #finale-overlay.visible { opacity: 1; pointer-events: auto; }

        .finale-content {
            text-align: center;
            width: 90%; /* Largura responsiva */
            max-width: 600px;
            padding: 2rem;
            max-height: 85vh; /* Altura máxima para não sair da tela */
            overflow-y: auto; /* Permite rolar se o texto for longo */
            scrollbar-width: none; /* Firefox */
        }
        
        .finale-content::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .finale-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            line-height: 1.8;
            font-weight: 300;
            color: #fff;
            font-style: normal;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 2s ease 1s;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .finale-sub {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.3em;
            text-transform: uppercase;
            opacity: 0;
            transition: all 2s ease 3s;
        }

        #finale-overlay.visible .finale-text,
        #finale-overlay.visible .finale-sub {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- MENU INICIAL --- */
        #menu-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(5, 5, 16, 0.95);
            transition: opacity 1.5s ease, visibility 1.5s;
            padding: 2rem;
        }

        .menu-content {
            max-width: 700px;
            text-align: center;
            color: white;
            position: relative;
            width: 90%; /* Garante margem em mobile */
        }

        .menu-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            line-height: 1.8;
            font-weight: 300;
            margin-bottom: 2.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInText 2s forwards 0.5s;
        }

        .start-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 1.2rem 3.5rem;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-soft);
            border-radius: 4px;
            outline: none;
            touch-action: manipulation;
            position: relative;
            z-index: 10;
        }
        .start-btn:hover { background: white; color: black; }

        @keyframes fadeInText { to { opacity: 1; transform: translateY(0); } }

        /* --- PLAYER --- */
        .music-player {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 40;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(15, 15, 25, 0.85); 
            backdrop-filter: blur(15px);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 1s ease, transform 1s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: auto;
            opacity: 0;
        }

        .music-player.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        .music-player.fade-out { opacity: 0; transform: translateX(-50%) translateY(50px); pointer-events: none; }

        .play-btn {
            background: rgba(255,255,255,0.05);
            border: none;
            cursor: pointer;
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .play-btn svg { width: 20px; height: 20px; fill: white; }

        .track-info { display: flex; flex-direction: column; min-width: 120px; margin-right: 10px; }
        .track-name { font-size: 0.85rem; color: white; font-weight: 500; }
        .track-artist { font-size: 0.7rem; color: rgba(255, 255, 255, 0.6); }

        .equalizer { display: flex; gap: 3px; height: 15px; align-items: flex-end; }
        .bar { width: 3px; background: white; animation: equalize 1s infinite ease-in-out; }
        .bar:nth-child(1) { animation-duration: 0.8s; height: 60%; }
        .bar:nth-child(2) { animation-duration: 1.1s; height: 80%; }
        .bar:nth-child(3) { animation-duration: 0.9s; height: 40%; }
        .equalizer.paused .bar { animation-play-state: paused; height: 3px !important; }
        @keyframes equalize { 0%, 100% { height: 20%; } 50% { height: 100%; } }

        /* Texto Overlay das Constelações */
        #text-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 5; }
        .quote-label {
            position: absolute;
            width: 300px;
            font-family: 'Cormorant Garamond', serif;
            color: var(--text-main);
            font-size: 1.3rem;
            line-height: 1.5;
            text-align: center;
            opacity: 0;
            transition: opacity 1s ease, transform 0.1s linear;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
            pointer-events: none;
        }
        .quote-label.visible { opacity: 1; }
        .quote-label.celestial-title { font-weight: 600; font-size: 1.6rem; letter-spacing: 0.1em; color: var(--star-discovered); display: block; margin-bottom: 5px; }

        /* Mobile tweaks */
        @media (max-width: 768px) {
            .discovery-hud { top: 1rem; right: 1rem; }
            .music-player { bottom: 1.5rem; width: 90%; justify-content: space-between; }
            .quote-label { width: 85vw; font-size: 1.1rem; }
            .menu-text { font-size: 0.95rem; }

            /* Ajustes Responsivos Texto Final */
            .finale-content {
                width: 95%;
                padding: 1.5rem;
                max-height: 80vh;
            }
            .finale-text {
                font-size: 1.1rem; /* Fonte ligeiramente menor */
                line-height: 1.6;
                margin-bottom: 1.5rem;
            }
        }
        
        .hidden { opacity: 0 !important; visibility: hidden !important; }
    </style>
</head>
<body>

    <!-- HUD de Progresso -->
    <div class="discovery-hud" id="hud">
        <span class="hud-counter" id="counter-text">0 / 0</span>
    </div>

    <!-- Overlay Final -->
    <div id="finale-overlay">
        <div class="finale-content">
            <p class="finale-text">"Preciso admitir que é inesperado eu te dedicar algo assim. A gente se conhece há <span id="days-counter" style="color: var(--star-gold); font-weight: 600;"></span> dias, e mesmo assim me senti obrigado a criar isso pra você. E, sendo sincero, hoje eu me sinto completo: estando perto de Deus, sendo íntimo de você e estando estabilizado nas demais áreas da minha vida. 

Você entrou no momento em que eu menos esperava, mas, eu sempre soube que você chegaria. Pedi a Deus que minha esposa fosse linda, atenciosa, seguidora de Cristo, uma mulher de Provérbios 31:10... E você carrega todas essas virtudes.

Obrigado por tudo desde que nos conhecemos. Mesmo com pouco tempo, já tenho a certeza de que é com você que quero passar o resto dos meus dias. Desde aquele dia de novembro, venho me esforçando todos os dias para ser um homem de verdade, especialmente por você.

E que, assim como esse céu estrelado, a nossa vida seja cheia de amor, carinho, respeito e reciprocidade."</p>
        </div>
    </div>

    <!-- Menu Inicial -->
    <div id="menu-overlay">
        <div class="menu-content">
            <p class="menu-text">
                Duda, essas frases eu guardo faz uns 2 anos. Nenhuma foi gerada por IA; fui fundo pesquisando e reunindo as melhores. <br><br>
                Queria dedicar todas elas pra você nesse site que eu codei. <br>
            </p>
            <button class="start-btn" id="start-btn">Entrar no Universo</button>
        </div>
    </div>

    <!-- Áudios -->
    <audio id="bg-music" loop>
        <source src="musica/MUSICADELA.mp3" type="audio/mpeg">
    </audio>
    <audio id="finale-music">
        <source src="musica/MUSICAFINAL.mp3" type="audio/mpeg">
    </audio>

    <!-- Player -->
    <div class="music-player" id="music-player">
        <button class="play-btn" id="toggle-music">
            <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pause-icon" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <div class="equalizer paused" id="equalizer">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div class="track-info">
            <span class="track-name">O Céu Explica Tudo</span>
            <span class="track-artist">Henrique & Juliano</span>
        </div>
    </div>

    <div id="text-overlay"></div>
    <canvas id="canvas"></canvas>

    <script>
        // --- CONFIGURAÇÃO ---
        const QUOTES = [
            "Dizem que um homem só se apaixona uma única vez, isso de fato é uma mentira, pois me apaixonei no brilho de seus olhos, no teu mais belo sorriso, e em tua mais doce voz.",
            "Você é tão linda que a lua e o sol se revezam para contemplar sua beleza.",
            "Você é a resposta de todas as minhas orações",
            "Existem 7.000 idiomas, 650.000 palavras no mundo e, no entanto, toda vez que vejo você, ainda fico totalmente sem palavras.",
            "Eu só pensei que havia dois tipos de amor, aquele pelo qual você mataria e aquele pelo qual você morreria, mas ver você me fez perceber que você era o tipo de amor pelo qual eu viveria.",
            "Toda vez que desvio o olhar de você, me encontro procurando por você.",
            "Se eu pudesse mudar as coisas, mudaria a lua para seus olhos e o sol para seu sorriso, então me deitaria com seu olhar e me levantaria com seu sorriso.",
            "Eles podem dizer que você é o Sol que ilumina tudo em seu caminho, mas para mim você é a Lua, que ilumina a escuridão nos momentos mais carentes.",
            "Seus olhos ganhariam um espaço no céu, pois eles brilham mais do que as próprias estrelas.",
            "A lua é a beleza de Deus, o sol é o poder de Deus e você é sua mais bela criação.",
            "Quando o sol nasce, você não tem sombra, porque não há nada que possa replicar sua beleza.",
            "Seus olhos são como nuvens, pois mesmo quando eles enchem de tristeza e afogam a terra, eles pintam o céu com uma beleza inimaginável.",
            "Existem incontáveis estrelas no universo, mas a única que me encanta com seu brilho só pode ser encontrada na vastidão dos seus olhos.",
            "Espero que, com cada oração sussurrada, algum dia, em breve, nossos caminhos na verdade sejam compartilhados. Até então, meu amor, em sonhos eu vou te abraçar e valorizar cada momento, mesmo que eles desapareçam.",
            "Tenho conversas noturnas com a lua, ela me fala do sol e eu falo de você.",
            "O elogio mais belo e profundo nunca será suficiente pra você, pois sua beleza ultrapassa todos os meios de pronúncia.",
            "Se você carregasse a maldição da Medusa, eu ainda olharia para seus olhos para que meu corpo de pedra pudesse contemplar a perfeição para a eternidade.",
            "Sua beleza me surpreende pois ao colocar meus olhos em você é como receber uma recompensa não destinada a mim ou a qualquer outra pessoa.",
            "Eu já presenciei a gloriosa luz de mil sóis, isso foi o suficiente para eu perceber que somente a sua presença faz com que todas aquelas luzes tornem apenas mais algumas partículas de fótons, comparado ao brilho de teu olhar.",
            "Eu observei as estrelas por horas entediado, mas quando olhei em seus olhos nem pude ver o tempo passar, tudo parou, exceto o meu encanto por você.",
            "Eu caminharia no mesmo deserto, passaria pelo mesmo pântano, nadaria nos mesmos mares se me falassem que no fim do caminho, eu te encontraria.",
            "Se eu pudesse pedir para Deus refazer o universo, pediria para Ele substituir você pela lua entre as estrelas, então eu poderia olhar para você todas as noites.",
            "Se você for o sol, eu serei Ícaro, um tolo fadado a cair e queimar antes mesmo de chegar até você. Mesmo em asas de cera, eu voaria em sua direção.",
            "Deus nos deu dois ouvidos, dois olhos, duas pernas e duas mãos, mas Ele só nos deu um coração, e Ele queria que eu te encontrasse e te dissesse, você é o segundo.",
            "Seus olhos são como um labirinto, quando olho para eles me perco, descubro que não quero sair daquele labirinto.",
            "Se eu ficasse cego no momento em que colocasse meus olhos em você, eu não lamentaria, pois naquele momento eu já tinha visto toda a beleza que este mundo tinha para mostrar.",
            "Os girassóis devem se voltar para você, pois confundem sua beleza brilhante com o sol.",
            "Há tantas estrelas no céu noturno, mas há uma que brilha e faisca mais, como aquela vez em que te vi brilhando e brilhando na multidão.",
            "Não vejo por que os astronautas vão ao espaço para que possam ver o mundo, vejo o meu só de olhar para você.",
            "As estrelas tinham tanta inveja de como você era brilhante que forçaram o sol a cair para sua morte apenas para serem vistas, mas você as ofuscou todas as vezes.",
            "Meus sonhos se transformam em pesadelos no momento em que acordo, mas você na minha frente me faz pensar se estou sempre sonhando.",
            "Um dia lembro-me de sentir meu coração cair e congelar atordoado com a obra-prima de Deus. Percebi que estava olhando para você.",
            "Van Gogh teria tido inveja de mim, porque ele pintou a noite estrelada apenas uma vez, e eu consigo ver as mais belas estrelas somente olhando em teus olhos.",
            "Assim como a noite é estrelada, você possui uma imensidão de estrelas no olhar. Você é admirável como os girassóis. Van Gogh ficaria fascinado, pois você é a junção das suas belas obras.",
            "Pintores buscaram retratar a perfeição e não conseguiram, mas eu vejo o que tanto buscaram em seus olhos.",
            "Van Gogh não conseguiu fazer as mais belas estrelas, nem a mais bela constelação. Isso só aconteceu porque ele não conhecia a existência dos seus olhos.",
            "Descobri o motivo da tristeza do velho homem que Van Gogh retrata no quadro “Sorrowing Old Man”. O motivo de sua tristeza foi o fato de ele nunca poder admirar uma garota igual você.",
            "Van Gogh disse que a visão das estrelas o fazia sonhar, mas se ele visse as estrelas que eu vejo em seus olhos, ele nunca mais iria querer acordar.",
            "Van Gogh só conseguiu retratar o amarelo nos girassóis porque ele não viu o arco-íris que você transmite no seu olhar.",
            "Van Gogh só amou as estrelas porque ele não viu a constelação do seu olhar.",
            "Se você morrer, eu ficaria com inveja da terra que pode te abraçar por toda a eternidade.",
            "Eu queria ser uma de suas lágrimas, para poder nascer em seus olhos, escorrer pela sua bochecha e morrer em seus lábios.",
            "Se eu me atrevesse a gritar ao mundo o quanto eu te amo, eu simplesmente sussurraria isso em seus ouvidos. Pois o meu mundo é você.",
            "Dizem que as pessoas só podem estar em um lugar de cada vez, mas isso é errado, pois você está em minha mente e em meu coração ao mesmo tempo.",
            "Durante séculos, os humanos usaram as estrelas para guiá-los em suas jornadas. Mas toda vez que olho em seus olhos, me perco.",
            "Eu não te amo com meu coração ou mente. Eu te amo com minha alma, caso minha mente esqueça e meu coração pare.",
            "Se eu tivesse que esperar minha vida inteira para experimentar o seu amor, eu o faria. E morrendo após isso ficaria feliz, pois eu teria experimentado o céu antes mesmo de alcançá-lo.",
            "Mesmo em tempos que lembram preto e branco, você continua a brilhar como ouro para mim.",
            "Se eu tivesse uma flor para cada pensamento em você, eu poderia andar pelo meu jardim para a eternidade.",
            "Se eu fosse aprender todas as línguas do mundo, ainda não encontraria as palavras exatas para expressar o quanto te amo.",
            "Se eu tivesse que escolher entre o sol e a lua ou as estrelas, eu escolheria seus olhos como eles brilham mais do que todos eles.",
            "Se minha alma fosse uma caneta e meu coração tinta, com o sangue de minhas veias eu escreveria “eu te amo”.",
            "Os girassóis devem se voltar para você, pois confundem sua beleza brilhante com o sol.",
            "Por que eu olharia para outras estrelas quando já me apaixonei pela lua?",
            "Quando te conheci percebi que os anjos nunca nos convidariam, porque se vissem a perfeição com que Deus te criou, seu ciúme causaria guerra.",
            "Dizem que a Fossa das Marianas é o lugar mais profundo da terra, mas isso é falso, pois ela não se compara à profundidade do meu amor por você.",
            "Se o sol desaparecesse não faria diferença porque você brilha mais do que qualquer estrela do universo.",
            "Não importa o quão bonito seja o pôr do sol, nada pode comparar sua beleza, pois mesmo que o sol se ponha, seu brilho ainda iluminaria meu mundo.",
            "Se eu tivesse que escolher entre respirar e te amar, daria meu último suspiro para dizer que te amo.",
            "Dizem que a beleza está nos olhos de quem vê, mas com o jeito que você me balança com seu abraço caloroso, até os cegos podem imaginar sua beleza.",
            "Um dia você vai me perguntar quem é a vida mais importante, a sua ou a minha, ao que eu responderei a minha e você irá embora sem saber.",
            "Você roubou meu fôlego, minha atenção, meu coração e meus pensamentos, mas imploro que tire mais de mim, até mesmo meu sobrenome.",
            "Você não tem reflexo meu amor, porque nada neste mundo pode replicar a beleza divina que você possui."
        ];

        // --- SISTEMA ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const textOverlay = document.getElementById('text-overlay');
        const menu = document.getElementById('menu-overlay');
        const hud = document.getElementById('hud');
        const counterText = document.getElementById('counter-text');
        
        // Áudio
        const bgMusic = document.getElementById('bg-music');
        const finaleMusic = document.getElementById('finale-music');
        const musicPlayer = document.getElementById('music-player');
        const toggleMusicBtn = document.getElementById('toggle-music');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const equalizer = document.getElementById('equalizer');
        const startBtn = document.getElementById('start-btn');

        bgMusic.volume = 0.4;
        finaleMusic.volume = 0;

        // Estado
        let width, height;
        let zoom = 0.45;
        let targetZoom = 0.45;
        let panX = 0, panY = 0;
        let targetPanX = 0, targetPanY = 0;
        
        let isDragging = false;
        let lastMouseX = 0, lastMouseY = 0;
        let initialPinchDistance = null;
        let initialZoom = null;

        const constellations = [];
        // Finale Background Elements
        const shootingStars = [];
        const planets = [];

        const SPREAD = 12000;
        let discoveredCount = 0;
        let totalConstellations = 0;
        let isFinaleActive = false;
        let finaleStartTime = 0;

        // Hint System
        let lastDiscoveryTime = Date.now();
        let currentHintIndex = -1;
        const HINT_DELAY = 10000; // 10 segundos para dar dica

        // Debug
        let dKeyCount = 0;
        let dKeyTimer = null;

        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        class Constellation {
            constructor(quote, id, type = 'normal') {
                this.quote = quote;
                this.id = id;
                this.type = type; 
                this.isDiscovered = false;
                this.isHinted = false;
                
                if (type === 'sun') {
                    this.worldX = 1500; this.worldY = -1200;
                } else if (type === 'moon') {
                    this.worldX = -1800; this.worldY = 1500;
                } else {
                    const r1 = seededRandom(id * 456);
                    const r2 = seededRandom(id * 654);
                    this.worldX = (r1 - 0.5) * SPREAD;
                    this.worldY = (r2 - 0.5) * SPREAD;
                }

                this.stars = [];
                const count = type !== 'normal' ? 1 : (3 + Math.floor(seededRandom(id) * 5));
                
                for(let i=0; i<count; i++) {
                    const angle = seededRandom(id + i) * Math.PI * 2;
                    const dist = 30 + seededRandom(id + i * 10) * 80;
                    
                    // Velocidade do pulso: Sol e Lua bem mais lentos (0.005), outros normais
                    let speed = 0.02 + seededRandom(id) * 0.03;
                    if (type === 'sun' || type === 'moon') speed = 0.005;

                    this.stars.push({
                        dx: i === 0 ? 0 : Math.cos(angle) * dist,
                        dy: i === 0 ? 0 : Math.sin(angle) * dist,
                        size: type === 'sun' ? 50 : (type === 'moon' ? 40 : 1.5 + seededRandom(id + i) * 2),
                        baseSize: type === 'sun' ? 50 : (type === 'moon' ? 40 : 1.5 + seededRandom(id + i) * 2),
                        pulse: seededRandom(id + i) * Math.PI * 2,
                        pulseSpeed: speed
                    });
                }

                this.el = document.createElement('div');
                this.el.className = 'quote-label';
                
                if (type === 'sun') {
                    this.el.innerHTML = `<span class="celestial-title">O Sol</span>${quote}`;
                    this.el.style.color = "#fbbf24";
                } else if (type === 'moon') {
                    this.el.innerHTML = `<span class="celestial-title">A Lua</span>${quote}`;
                    this.el.style.color = "#cbd5e1";
                } else {
                    this.el.textContent = quote;
                }
                textOverlay.appendChild(this.el);
            }

            draw(ctx, currentZoom, currentPanX, currentPanY) {
                const screenX = width / 2 + (this.worldX + currentPanX) * currentZoom;
                const screenY = height / 2 + (this.worldY + currentPanY) * currentZoom;

                // Culling
                const margin = 400 * currentZoom;
                if (screenX < -margin || screenX > width + margin || screenY < -margin || screenY > height + margin) {
                    if (this.el.classList.contains('visible')) this.el.classList.remove('visible');
                    return;
                }

                const dx = screenX - width / 2;
                const dy = screenY - height / 2;
                const distToCenter = Math.sqrt(dx*dx + dy*dy);
                const isCentered = distToCenter < 200; 

                const showLines = currentZoom > 0.6 && this.type === 'normal';
                const canDiscover = currentZoom > 1.1;

                if (showLines || this.isDiscovered || this.isHinted) {
                    ctx.beginPath();
                    // Cor da linha: Ciano se descoberto, Dourado se Dica, Invisivel se normal
                    let strokeColor = 'rgba(255, 255, 255, 0.06)';
                    if (this.isDiscovered) strokeColor = 'rgba(186, 230, 253, 0.3)';
                    else if (this.isHinted) strokeColor = 'rgba(251, 191, 36, 0.3)';

                    ctx.strokeStyle = strokeColor;
                    ctx.lineWidth = (this.isDiscovered || this.isHinted ? 1.5 : 0.5) * currentZoom;
                    
                    this.stars.forEach((s, i) => {
                        const sx = screenX + s.dx * currentZoom;
                        const sy = screenY + s.dy * currentZoom;
                        if (i === 0) ctx.moveTo(sx, sy);
                        else ctx.lineTo(sx, sy);
                    });
                    ctx.stroke();
                }

                this.stars.forEach((s) => {
                    const sx = screenX + s.dx * currentZoom;
                    const sy = screenY + s.dy * currentZoom;
                    
                    s.pulse += s.pulseSpeed;
                    
                    // Intensidade do pulso
                    let pulseIntensity = 0.2;
                    if (this.isDiscovered) pulseIntensity = 0.4;
                    if (this.isHinted) pulseIntensity = 0.6; // Dica pulsa forte

                    const pulseScale = 1 + Math.sin(s.pulse) * pulseIntensity;
                    let size = s.baseSize * Math.max(currentZoom, 0.3) * pulseScale;
                    
                    let fillStyle = '#ffffff';
                    let shadowBlur = 0;
                    let shadowColor = 'transparent';

                    if (this.type === 'sun') {
                        const grad = ctx.createRadialGradient(sx, sy, 0, sx, sy, size * 2);
                        grad.addColorStop(0, '#fffbe6');
                        grad.addColorStop(0.4, '#fbbf24');
                        grad.addColorStop(1, 'transparent');
                        fillStyle = grad;
                        shadowBlur = 50 * currentZoom;
                        shadowColor = '#fbbf24';
                    } else if (this.type === 'moon') {
                        const grad = ctx.createRadialGradient(sx, sy, 0, sx, sy, size * 1.5);
                        grad.addColorStop(0, '#f8fafc');
                        grad.addColorStop(0.5, '#cbd5e1');
                        grad.addColorStop(1, 'transparent');
                        fillStyle = grad;
                        shadowBlur = 30 * currentZoom;
                        shadowColor = '#cbd5e1';
                    } else if (this.isDiscovered) {
                        fillStyle = '#e0f2fe'; 
                        shadowBlur = 20 * currentZoom;
                        shadowColor = 'rgba(186, 230, 253, 0.6)';
                    } else if (this.isHinted) {
                        // Estilo da Dica: Dourado Pulsante
                        fillStyle = '#fbbf24';
                        shadowBlur = 25 * currentZoom;
                        shadowColor = 'rgba(251, 191, 36, 0.8)';
                    } else {
                        fillStyle = `rgba(255, 255, 255, ${0.4 + (currentZoom * 0.1)})`;
                    }

                    ctx.fillStyle = fillStyle;
                    ctx.shadowBlur = shadowBlur;
                    ctx.shadowColor = shadowColor;
                    ctx.beginPath();
                    ctx.arc(sx, sy, size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });

                // Trigger
                if (canDiscover && isCentered && !this.isDiscovered && !isFinaleActive) {
                    triggerDiscovery(this);
                }

                // Texto
                if ( (canDiscover && isCentered) || (this.isDiscovered && currentZoom > 0.8) ) {
                    const offset = this.type === 'normal' ? 40 : 70;
                    this.el.style.transform = `translate3d(${screenX}px, ${screenY + offset * currentZoom}px, 0) translateX(-50%)`;
                    this.el.classList.add('visible');
                } else {
                    this.el.classList.remove('visible');
                }
            }
        }

        function triggerDiscovery(constellation) {
            constellation.isDiscovered = true;
            // Limpa dica se esta for a dica, ou reseta o timer de qualquer forma
            if (constellation.isHinted) constellation.isHinted = false;
            currentHintIndex = -1; // Reseta indice de dica
            lastDiscoveryTime = Date.now(); // Reseta timer

            discoveredCount++;
            counterText.textContent = `${discoveredCount} / ${totalConstellations}`;
            if (discoveredCount === totalConstellations) {
                setTimeout(startFinale, 1000);
            }
        }

        function checkForHints() {
            if (isFinaleActive) return;
            // Se passou o tempo e não temos uma dica ativa
            if (Date.now() - lastDiscoveryTime > HINT_DELAY && currentHintIndex === -1) {
                // Procurar candidata
                const undiscovered = constellations.filter(c => !c.isDiscovered);
                if (undiscovered.length > 0) {
                    const randomC = undiscovered[Math.floor(Math.random() * undiscovered.length)];
                    randomC.isHinted = true;
                    // Encontrar o indice dela no array original para referência futura se precisar
                    currentHintIndex = constellations.indexOf(randomC);
                }
            }
        }

        // --- SISTEMA DE BACKGROUND PARA O FINAL ---
        
        function initFinaleBackground() {
            for (let i = 0; i < 5; i++) {
                planets.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: 50 + Math.random() * 100,
                    color: i % 2 === 0 ? 'rgba(7, 89, 133, 0.1)' : 'rgba(88, 28, 135, 0.05)',
                    vx: (Math.random() - 0.5) * 0.2,
                    vy: (Math.random() - 0.5) * 0.2
                });
            }
        }

        function drawFinaleBackground(ctx) {
            planets.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                if(p.x < -200) p.x = width + 200;
                if(p.x > width + 200) p.x = -200;
                if(p.y < -200) p.y = height + 200;
                if(p.y > height + 200) p.y = -200;

                const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
                grad.addColorStop(0, p.color);
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            if (Math.random() < 0.03) { 
                shootingStars.push({
                    x: Math.random() * width,
                    y: Math.random() * height * 0.5,
                    vx: 10 + Math.random() * 10,
                    vy: 2 + Math.random() * 5,
                    len: 0,
                    life: 1.0
                });
            }

            for (let i = shootingStars.length - 1; i >= 0; i--) {
                const s = shootingStars[i];
                s.x += s.vx;
                s.y += s.vy;
                s.len = Math.min(s.len + 2, 100);
                s.life -= 0.01;
                ctx.strokeStyle = `rgba(255, 255, 255, ${s.life})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(s.x, s.y);
                ctx.lineTo(s.x - s.vx * (s.len/20), s.y - s.vy * (s.len/20));
                ctx.stroke();
                if (s.life <= 0 || s.x > width + 100 || s.y > height + 100) {
                    shootingStars.splice(i, 1);
                }
            }
        }

        function startFinale() {
            if (isFinaleActive) return;
            isFinaleActive = true;
            finaleStartTime = Date.now();
            
            initFinaleBackground();

            // UI Fade Out
            musicPlayer.classList.add('fade-out');
            hud.style.opacity = '0';
            textOverlay.style.opacity = '0';

            // Calcular zoom ideal para ver todo o universo (SPREAD 12000)
            // Margem de 1.2 para não ficar colado nas bordas
            const minDim = Math.min(width, height);
            const idealZoom = minDim / (SPREAD * 1.3); // Zoom calibrado
            
            targetZoom = idealZoom; 
            targetPanX = 0;
            targetPanY = 0;

            // Audio Transition
            const fadeAudio = setInterval(() => {
                if (bgMusic.volume > 0.05) {
                    bgMusic.volume -= 0.05;
                } else {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                    clearInterval(fadeAudio);
                }
            }, 200);

            finaleMusic.play();
            let vol = 0;
            const fadeInFinale = setInterval(() => {
                if (vol < 0.8) {
                    vol += 0.05;
                    finaleMusic.volume = vol;
                } else {
                    clearInterval(fadeInFinale);
                }
            }, 200);
        }

        // --- DRAW FINAL ---
        function drawFinaleConnections(ctx) {
            const duration = 35000; // 35 segundos (Mais lento e majestoso)
            const elapsed = Date.now() - finaleStartTime;
            let progress = Math.min(elapsed / duration, 1);
            // Easing
            progress = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

            const totalPoints = constellations.length;
            const maxIndex = Math.floor(progress * totalPoints);

            ctx.beginPath();
            // Cor Dourada Brilhante para conexão
            ctx.strokeStyle = '#fbbf24'; 
            ctx.lineWidth = 20 * zoom;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (totalPoints > 0) {
                let startX = width/2 + (constellations[0].worldX + panX) * zoom;
                let startY = height/2 + (constellations[0].worldY + panY) * zoom;
                ctx.moveTo(startX, startY);

                for (let i = 1; i < totalPoints; i++) {
                    const c = constellations[i];
                    const cx = width/2 + (c.worldX + panX) * zoom;
                    const cy = height/2 + (c.worldY + panY) * zoom;

                    if (i <= maxIndex) {
                        ctx.lineTo(cx, cy);
                    } else if (i === maxIndex + 1) {
                        const prevC = constellations[i-1];
                        const prevX = width/2 + (prevC.worldX + panX) * zoom;
                        const prevY = width/2 + (prevC.worldY + panY) * zoom;
                        const segmentFraction = (progress * totalPoints) - maxIndex;
                        const curX = prevX + (cx - prevX) * segmentFraction;
                        const curY = prevY + (cy - prevY) * segmentFraction;
                        ctx.lineTo(curX, curY);
                    }
                }
            }
            
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#fbbf24';
            ctx.stroke();
            ctx.shadowBlur = 0;

            if (progress >= 0.99) {
                document.getElementById('finale-overlay').classList.add('visible');
            }
        }

        function init() {
            resize();
            constellations.push(new Constellation(QUOTES[1], 0, 'sun'));
            constellations.push(new Constellation(QUOTES[7], 1, 'moon'));
            
            let idCounter = 2;
            QUOTES.forEach((q, i) => {
                if (i !== 1 && i !== 7) {
                    constellations.push(new Constellation(q, idCounter++));
                }
            });
            totalConstellations = constellations.length;
            counterText.textContent = `0 / ${totalConstellations}`;
            calculateDays(); // Atualiza contador de dias ao iniciar
            animate();
        }

        // Função do Contador de Dias
        function calculateDays() {
            // Data de início: 14/12/2025 (Ano, Mês-1, Dia)
            // Lembre-se que em JS meses começam do 0 (Jan=0, Dez=11)
            const startDate = new Date(2025, 11, 14); // 14 de Dezembro de 2025
            const today = new Date();
            
            // Diferença em milissegundos
            const diffTime = Math.abs(today - startDate);
            // Converter para dias (1000ms * 60s * 60m * 24h)
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            const element = document.getElementById('days-counter');
            if(element) element.textContent = diffDays;
        }

        function animate() {
            // Se finale ativo, mantemos zoom e pan travados no centro
            if (isFinaleActive) {
                // Recalcular zoom ideal caso user redimensione a janela durante o final
                const minDim = Math.min(width, height);
                const idealZoom = minDim / (SPREAD * 1.3);
                targetZoom = idealZoom;
                targetPanX = 0;
                targetPanY = 0;
            }

            zoom = zoom + (targetZoom - zoom) * 0.04;
            panX = panX + (targetPanX - panX) * 0.04;
            panY = panY + (targetPanY - panY) * 0.04;

            checkForHints();

            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, width, height);

            if (isFinaleActive) {
                drawFinaleBackground(ctx);
            }

            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            for(let i=0; i<300; i++) {
                const r1 = seededRandom(i);
                const r2 = seededRandom(i+1000);
                let bgX = (r1 * width + panX * 0.05 * zoom) % width;
                let bgY = (r2 * height + panY * 0.05 * zoom) % height;
                if (bgX < 0) bgX += width;
                if (bgY < 0) bgY += height;
                const size = Math.random() < 0.05 ? 1.5 : 0.8;
                ctx.beginPath();
                ctx.arc(bgX, bgY, size, 0, Math.PI * 2);
                ctx.fill();
            }

            if (isFinaleActive) {
                drawFinaleConnections(ctx);
            }

            constellations.forEach(c => c.draw(ctx, zoom, panX, panY));
            requestAnimationFrame(animate);
        }

        // --- INPUTS ---
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);

        // Debug Key (D x 7)
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'd') {
                dKeyCount++;
                if (dKeyTimer) clearTimeout(dKeyTimer);
                dKeyTimer = setTimeout(() => { dKeyCount = 0; }, 1000); // Reseta se demorar mais de 1s entre cliques

                if (dKeyCount >= 7) {
                    startFinale();
                    dKeyCount = 0;
                }
            }
        });

        window.addEventListener('wheel', (e) => {
            if (isFinaleActive) return; // Trava zoom no final
            targetZoom -= e.deltaY * 0.001;
            targetZoom = Math.min(Math.max(targetZoom, 0.05), 4);
        }, { passive: true });

        window.addEventListener('mousedown', (e) => {
            if (isFinaleActive) return; // Trava pan no final
            if (e.target.closest('.music-player, #menu-overlay')) return;
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
            
            // Reseta hint timer na interação
            lastDiscoveryTime = Date.now();
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            targetPanX += (e.clientX - lastMouseX) / zoom;
            targetPanY += (e.clientY - lastMouseY) / zoom;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            lastDiscoveryTime = Date.now();
        });

        window.addEventListener('mouseup', () => { isDragging = false; canvas.style.cursor = 'grab'; });

        // Touch
        canvas.addEventListener('touchstart', (e) => {
            if (isFinaleActive) return;
            if (e.target.closest('.music-player')) return;
            if (e.touches.length === 1) {
                isDragging = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
                initialZoom = targetZoom;
            }
            lastDiscoveryTime = Date.now();
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (isFinaleActive) return;
            if (e.target.closest('.music-player')) return;
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) {
                const x = e.touches[0].clientX;
                const y = e.touches[0].clientY;
                targetPanX += (x - lastMouseX) / zoom;
                targetPanY += (y - lastMouseY) / zoom;
                lastMouseX = x;
                lastMouseY = y;
            } else if (e.touches.length === 2 && initialPinchDistance) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const scale = distance / initialPinchDistance;
                targetZoom = Math.min(Math.max(initialZoom * scale, 0.05), 4);
            }
            lastDiscoveryTime = Date.now();
        }, { passive: false });
        window.addEventListener('touchend', () => { isDragging = false; initialPinchDistance = null; });

        // UI Logic
        function updatePlayerUI() {
            if (!bgMusic.paused) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                equalizer.classList.remove('paused');
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                equalizer.classList.add('paused');
            }
        }
        bgMusic.addEventListener('play', updatePlayerUI);
        bgMusic.addEventListener('pause', updatePlayerUI);
        toggleMusicBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (bgMusic.paused) bgMusic.play();
            else bgMusic.pause();
        });
        startBtn.addEventListener('click', () => {
            menu.classList.add('hidden');
            hud.classList.add('visible');
            bgMusic.play().catch(() => {});
            setTimeout(() => { musicPlayer.classList.add('visible'); }, 1000);
            setTimeout(() => { targetZoom = 0.65; }, 500);
        });

        init();
    </script>
</body>
</html>